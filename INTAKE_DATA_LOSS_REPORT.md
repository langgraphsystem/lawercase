# –û—Ç—á–µ—Ç –æ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

**–î–∞—Ç–∞**: 2025-11-28
**User ID**: 7314014306
**Case ID**: 4d60bb22-fdef-411f-bff5-46cade9693aa

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç **–æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–ï —Å–æ—Ö—Ä–∞–Ω —è—é—Ç—Å—è** –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Supabase.

## –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- **Intake Progress** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –¢–µ–∫—É—â–∏–π –±–ª–æ–∫: `university` (–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç / –ö–æ–ª–ª–µ–¥–∂)
- –¢–µ–∫—É—â–∏–π —à–∞–≥: 0
- **–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏**:
  1. `basic_info` (–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) - 6 –≤–æ–ø—Ä–æ—Å–æ–≤
  2. `family_childhood` (–°–µ–º—å—è –∏ —Ä–∞–Ω–Ω–µ–µ –¥–µ—Ç—Å—Ç–≤–æ) - 4 –≤–æ–ø—Ä–æ—Å–∞
  3. `school` (–®–∫–æ–ª–∞) - 8 –≤–æ–ø—Ä–æ—Å–æ–≤
- **–í–°–ï–ì–û –ø—Ä–æ–π–¥–µ–Ω–æ**: 18 –≤–æ–ø—Ä–æ—Å–æ–≤

### ‚ùå –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:
- **Semantic Memory**: 0 –∑–∞–ø–∏—Å–µ–π (–æ–∂–∏–¥–∞–ª–æ—Å—å: 18)
- **Episodic Memory**: 0 –∑–∞–ø–∏—Å–µ–π
- **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö**: 100%

## –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ë–î:

```
üìä –î–∞–Ω–Ω—ã–µ –≤ Supabase:
‚îú‚îÄ Cases: 8 –∫–µ–π—Å–æ–≤ –Ω–∞–π–¥–µ–Ω–æ
‚îú‚îÄ Intake Progress: 2 –∑–∞–ø–∏—Å–∏ (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é)
‚îú‚îÄ Semantic Memory: 0 –∑–∞–ø–∏—Å–µ–π ‚Üê –ü–†–û–ë–õ–ï–ú–ê
‚îî‚îÄ Episodic Memory: 0 —Å–æ–±—ã—Ç–∏–π ‚Üê –ü–†–û–ë–õ–ï–ú–ê
```

### –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏:

#### 1. –ë–ª–æ–∫ "–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" (basic_info)
**–í–æ–ø—Ä–æ—Å—ã (6 —à—Ç.):**
- –ü–æ–ª–Ω–æ–µ –∏–º—è
- –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
- –ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è
- –ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ
- –¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞
- –Ø–∑—ã–∫–∏

#### 2. –ë–ª–æ–∫ "–°–µ–º—å—è –∏ —Ä–∞–Ω–Ω–µ–µ –¥–µ—Ç—Å—Ç–≤–æ" (family_childhood)
**–í–æ–ø—Ä–æ—Å—ã (4 —à—Ç.):**
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
- –û—Ç–Ω–æ—à–µ–Ω–∏–µ —Å–µ–º—å–∏ –∫ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é
- –ò–Ω—Ç–µ—Ä–µ—Å—ã –≤ –¥–µ—Ç—Å—Ç–≤–µ

#### 3. –ë–ª–æ–∫ "–®–∫–æ–ª–∞" (school)
**–í–æ–ø—Ä–æ—Å—ã (8 —à—Ç.):**
- –®–∫–æ–ª—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —É—á–∏–ª–∏—Å—å
- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ —à–∫–æ–ª–µ
- –°–∏–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
- –û–ª–∏–º–ø–∏–∞–¥—ã –∏ –∫–æ–Ω–∫—É—Ä—Å—ã
- –†–æ–ª–∏ –≤ —à–∫–æ–ª–µ
- –ü—Ä–æ–µ–∫—Ç—ã –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
- –í–ª–∏—è—Ç–µ–ª—å–Ω—ã–µ —É—á–∏—Ç–µ–ª—è
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∫ –æ–±—É—á–µ–Ω–∏—é

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑

### –ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (intake_handlers.py:809-850)

–§—É–Ω–∫—Ü–∏—è `_save_response_to_memory()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:

```python
async def _save_response_to_memory(
    bot_context: BotContext,
    update: Update,
    case_id: str,
    question: IntakeQuestion,
    raw_response: str,
    normalized_value: Any,
) -> None:
    """Save intake response to semantic memory with fact synthesis."""
    user_id = str(update.effective_user.id)

    # Synthesize fact from Q&A
    fact_text = synthesize_intake_fact(question, raw_response)

    memory_record = MemoryRecord(
        text=fact_text,
        user_id=user_id,
        type="semantic",
        case_id=case_id,
        tags=question.tags if question.tags else ["intake"],
        metadata={
            "source": "intake_questionnaire",
            "question_id": question.id,
            "raw_response": raw_response,
            "normalized_value": str(normalized_value),
        },
    )

    try:
        await bot_context.mega_agent.memory.awrite([memory_record])
        logger.info("intake.response_saved_to_memory", ...)
    except Exception as e:
        logger.error("intake.save_memory_failed", error=str(e), ...)
```

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

1. **`memory.awrite()` –ø–∞–¥–∞–µ—Ç –º–æ–ª—á–∞** - exception –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏–ª–∏ –ª–æ–≥–∏ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è
2. **Transaction rollback** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
3. **Memory Manager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω** - bot_context.mega_agent.memory –Ω–µ —Å–æ–∑–¥–∞–Ω
4. **–¢–∞–±–ª–∏—Ü–∞ semantic_memory –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞** - –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∞–≤–∞–º–∏ –∏–ª–∏ —Å—Ö–µ–º–æ–π
5. **–§—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è** - —É—Å–ª–æ–≤–∏–µ –≥–¥–µ-—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

## –í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ

- **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: –í–´–°–û–ö–ê–Ø (Critical)
- **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö**: –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–µ—Ä—è—é—Ç—Å—è
- **–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É**:
  - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ç–∏—Ü–∏—é
  - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–µ–π—Å—É
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### 1. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
logger.debug(
    "intake.save_memory_attempt",
    user_id=user_id,
    case_id=case_id,
    question_id=question.id,
    fact_text_preview=fact_text[:50],
)

try:
    await bot_context.mega_agent.memory.awrite([memory_record])
    logger.info("intake.response_saved_to_memory", ...)
except Exception as e:
    logger.error(
        "intake.save_memory_failed",
        error=str(e),
        exc_info=True,  # –î–æ–±–∞–≤–∏—Ç—å traceback
        case_id=case_id,
        question_id=question.id,
    )
    # RE-RAISE –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã
    raise
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Memory Manager

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –Ω–∞—á–∞–ª–æ `_save_response_to_memory()`:

```python
if not bot_context.mega_agent.memory:
    logger.critical("intake.memory_not_initialized", user_id=user_id)
    raise RuntimeError("Memory Manager not initialized")
```

### 3. –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è Memory

–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø–∏—Å–∏ –≤ semantic_memory –Ω–∞–ø—Ä—è–º—É—é:

```python
# test_memory_write.py
memory_manager = MemoryManager(user_id=USER_ID)
record = MemoryRecord(text="Test record", user_id=USER_ID, type="semantic")
await memory_manager.awrite([record])
# Verify it's in DB
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ mega_agent.semantic_memory
SELECT grantee, privilege_type
FROM information_schema.role_table_grants
WHERE table_schema='mega_agent' AND table_name='semantic_memory';
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
2. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
3. ‚è≥ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è Memory
4. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É Memory Manager –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
5. ‚è≥ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
6. ‚è≥ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∫–æ–¥–æ–º

## –§–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

- `telegram_interface/handlers/intake_handlers.py:809-850` - –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- `core/memory/memory_manager.py` - Memory Manager
- `core/memory/stores/semantic_store.py` - Semantic Memory Store
- `logs/telegram_bot.log` - –õ–æ–≥–∏ –±–æ—Ç–∞ (—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ, –æ—Ç 04-11-2025)

---

**–°—Ç–∞—Ç—É—Å**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê - –¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
