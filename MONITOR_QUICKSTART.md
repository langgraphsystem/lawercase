# üöÄ Document Monitor - Quick Start Guide

## –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: 3-–º–∏–Ω—É—Ç–Ω—ã–π —Ç–µ—Å—Ç

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```bash
# –í–∞—Ä–∏–∞–Ω—Ç A: –ü—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
start index.html

# –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
python -m http.server 8080
# –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080/index.html
```

### –®–∞–≥ 2: –í–∫–ª—é—á–∏—Ç–µ Mock —Ä–µ–∂–∏–º

1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"üß™ Use Mock Data"** –≤ –≤–µ—Ä—Ö–Ω–µ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É
2. –ö–Ω–æ–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å—Ç–∞—Ç—å –∑–µ–ª–µ–Ω–æ–π: **"‚úÖ Mock Mode ON"**

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é

1. –ù–∞–∂–º–∏—Ç–µ –±–æ–ª—å—à—É—é —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É **"üöÄ –ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é"**
2. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–º:
   - –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –æ–±–Ω–æ–≤–ª—è—é—â–∏–º–∏—Å—è —Å—Ç–∞—Ç—É—Å–∞–º–∏
   - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
   - –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ª–æ–≥–∏

### –®–∞–≥ 4: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–ù–∞–≤–∏–≥–∞—Ü–∏—è:**
- –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å–µ–∫—Ü–∏—é –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª –∫ —Å–µ–∫—Ü–∏–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ

**–ó–∞–≥—Ä—É–∑–∫–∞ Exhibits:**
1. –í–≤–µ–¥–∏—Ç–µ ID: `2.1.A`
2. –í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π PDF —Ñ–∞–π–ª
3. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å"
4. –§–∞–π–ª –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

**–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:**
- –õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
- –¶–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞: —Å–∏–Ω–∏–π (info), –∑–µ–ª–µ–Ω—ã–π (success), –∫—Ä–∞—Å–Ω—ã–π (error)

### –®–∞–≥ 5: –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

–ß–µ—Ä–µ–∑ ~20 —Å–µ–∫—É–Ω–¥:
- –í—Å–µ —Å–µ–∫—Ü–∏–∏ —Å—Ç–∞–Ω—É—Ç –∑–µ–ª–µ–Ω—ã–º–∏ (‚úÖ completed)
- –ö–Ω–æ–ø–∫–∞ "üìÑ –°–∫–∞—á–∞—Ç—å PDF" –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç 100%

---

## –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å backend

### Checklist –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [ ] **1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –Ω–∞ FastAPI backend**

```python
# api/main.py –∏–ª–∏ api/main_production.py
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:8080"],  # –í–∞—à frontend URL
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

- [ ] **2. –î–æ–±–∞–≤—å—Ç–µ router –≤ FastAPI**

```python
# api/main.py
from api.routes import document_monitor

app.include_router(document_monitor.router)
```

- [ ] **3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ endpoints –≤ `api/routes/document_monitor.py`**

–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ TODO —Å–µ–∫—Ü–∏–∏ –≤ —Ñ–∞–π–ª–µ:
- `start_document_generation()` - –∑–∞–ø—É—Å–∫ workflow
- `get_document_preview()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- `upload_exhibit()` - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
- `download_petition_pdf()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF

- [ ] **4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ persistence layer**

–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏ state:

```python
async def save_workflow_state(thread_id: str, state: WorkflowState):
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis, PostgreSQL –∏–ª–∏ LangGraph checkpointer
    pass

async def load_workflow_state(thread_id: str) -> WorkflowState | None:
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ storage
    pass
```

- [ ] **5. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ —Å LangGraph workflow**

```python
from core.orchestration.workflow_graph import build_eb1a_workflow, WorkflowState

async def run_document_generation(thread_id: str, case_id: str, user_id: str):
    # –°–æ–∑–¥–∞—Ç—å initial state
    state = WorkflowState(
        thread_id=thread_id,
        case_id=case_id,
        user_id=user_id,
        workflow_step="generating",
        document_data={
            "sections": get_section_definitions("petition"),
            "exhibits": [],
            "logs": [],
            "started_at": datetime.now().isoformat(),
        }
    )

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
    await save_workflow_state(thread_id, state)

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow
    graph = build_eb1a_workflow()

    # Option A: Sync run
    final_state = await graph.ainvoke(state, config={"thread_id": thread_id})

    # Option B: Async streaming (for real-time updates)
    async for event in graph.astream(state, thread_id=thread_id):
        updated_state = event["state"]
        await save_workflow_state(thread_id, updated_state)
```

- [ ] **6. –û–±–Ω–æ–≤–∏—Ç–µ CONFIG –≤ index.html**

```javascript
const CONFIG = {
  API_BASE: 'http://localhost:8000/api',  // –í–∞—à backend URL
  POLL_INTERVAL: 2000,
  MAX_POLL_ERRORS: 5,
  MOCK_MODE: false,  // –û—Ç–∫–ª—é—á–∏—Ç—å mock —Ä–µ–∂–∏–º
};
```

- [ ] **7. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ end-to-end**

```bash
# Terminal 1: Backend
uvicorn api.main:app --reload --port 8000

# Terminal 2: Frontend
python -m http.server 8080

# –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080/index.html
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Mock Mode –í–´–ö–õ–Æ–ß–ï–ù
# –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é"
```

---

## –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå "Failed to fetch" –æ—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏

**–ü—Ä–∏—á–∏–Ω–∞**: CORS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ backend –Ω–µ –∑–∞–ø—É—â–µ–Ω

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω: `curl http://localhost:8000/api/health`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS middleware –≤ FastAPI
3. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Network tab –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—Ä–æ—Å—ã

---

### ‚ùå –°–µ–∫—Ü–∏–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç response –æ—Ç API

**–†–µ—à–µ–Ω–∏–µ**:
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Network ‚Üí –Ω–∞–π–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∫ `/api/document/preview/{thread_id}`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Response —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ö–µ–º–µ `DocumentPreviewResponse`
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `content_html` —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–π HTML

---

### ‚ùå "Thread not found" –ø—Ä–∏ polling

**–ü—Ä–∏—á–∏–Ω–∞**: State –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ**:
–†–µ–∞–ª–∏–∑—É–π—Ç–µ persistent storage:

```python
# –í–∞—Ä–∏–∞–Ω—Ç 1: Redis
import redis.asyncio as redis
import json

redis_client = redis.Redis(host='localhost', port=6379, decode_responses=True)

async def save_workflow_state(thread_id: str, state: WorkflowState):
    await redis_client.set(
        f"workflow:{thread_id}",
        state.model_dump_json(),
        ex=86400  # 24 hours expiry
    )

async def load_workflow_state(thread_id: str) -> WorkflowState | None:
    data = await redis_client.get(f"workflow:{thread_id}")
    if data:
        return WorkflowState.model_validate_json(data)
    return None
```

```python
# –í–∞—Ä–∏–∞–Ω—Ç 2: PostgreSQL (—á–µ—Ä–µ–∑ SQLAlchemy)
from sqlalchemy import Column, String, Text, DateTime
from sqlalchemy.ext.asyncio import AsyncSession

class WorkflowStateModel(Base):
    __tablename__ = "workflow_states"

    thread_id = Column(String, primary_key=True)
    state_json = Column(Text)
    updated_at = Column(DateTime, default=datetime.now)

async def save_workflow_state(thread_id: str, state: WorkflowState, db: AsyncSession):
    model = WorkflowStateModel(
        thread_id=thread_id,
        state_json=state.model_dump_json(),
    )
    await db.merge(model)
    await db.commit()
```

---

## Performance Tips

### 1. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ polling interval

```javascript
// –î–ª—è production - —É–≤–µ–ª–∏—á—å—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É
const CONFIG = {
  POLL_INTERVAL: 3000,  // 3 —Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ 2
};
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ WebSocket (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è real-time updates –±–µ–∑ polling:

```python
# Backend (FastAPI WebSocket)
from fastapi import WebSocket

@app.websocket("/ws/document/{thread_id}")
async def websocket_endpoint(websocket: WebSocket, thread_id: str):
    await websocket.accept()

    async for event in workflow_events_stream(thread_id):
        await websocket.send_json(event)
```

```javascript
// Frontend (–≤ index.html –∑–∞–º–µ–Ω–∏—Ç–µ DocumentMonitor.poll())
const ws = new WebSocket(`ws://localhost:8000/ws/document/${threadId}`);

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  this.updateUI(data);
};
```

### 3. –ö–µ—à–∏—Ä—É–π—Ç–µ completed —Å–µ–∫—Ü–∏–∏

```python
from functools import lru_cache

@lru_cache(maxsize=1000)
async def get_section_html(section_id: str, version: int):
    # Cache generated HTML to avoid re-rendering
    pass
```

---

## Production Deployment

### –í–∞—Ä–∏–∞–Ω—Ç 1: Serve –∏–∑ FastAPI static files

```python
# api/main.py
from fastapi.staticfiles import StaticFiles

app.mount("/monitor", StaticFiles(directory=".", html=True), name="monitor")

# –î–æ—Å—Ç—É–ø: http://yourserver.com/monitor/index.html
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–π Nginx frontend

```nginx
# nginx.conf
server {
    listen 80;
    server_name monitor.yourcompany.com;

    root /var/www/mega_agent_monitor;
    index index.html;

    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: Vercel/Netlify (–¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏)

```bash
# Deploy static file
vercel deploy --prod

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ ENV variable –¥–ª—è API_BASE
# –í index.html –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
const API_BASE = process.env.API_BASE || '/api';
```

---

## Security Considerations

### 1. Sanitize HTML content

```python
import bleach

ALLOWED_TAGS = ['h1', 'h2', 'h3', 'p', 'span', 'div', 'ul', 'ol', 'li', 'a']
ALLOWED_ATTRS = {'span': ['class'], 'div': ['class'], 'a': ['href', 'class']}

def sanitize_section_html(html: str) -> str:
    return bleach.clean(html, tags=ALLOWED_TAGS, attributes=ALLOWED_ATTRS, strip=True)
```

### 2. Validate exhibit uploads

```python
ALLOWED_MIME_TYPES = {
    'application/pdf',
    'image/jpeg',
    'image/png',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
}

MAX_FILE_SIZE = 10 * 1024 * 1024  # 10 MB

def validate_exhibit_file(file: UploadFile):
    if file.content_type not in ALLOWED_MIME_TYPES:
        raise HTTPException(400, "Invalid file type")

    # Check file size (read first chunk)
    # Implementation needed
```

### 3. Rate limiting

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@router.get("/document/preview/{thread_id}")
@limiter.limit("30/minute")  # Max 30 requests per minute
async def get_document_preview(request: Request, thread_id: str):
    # ...
```

---

## Monitoring & Observability

### Add metrics

```python
from prometheus_client import Counter, Histogram

document_generations = Counter(
    'document_generations_total',
    'Total document generations started'
)

generation_duration = Histogram(
    'document_generation_duration_seconds',
    'Document generation duration'
)

@router.post("/generate-petition")
async def start_document_generation(...):
    document_generations.inc()

    with generation_duration.time():
        # ... generation logic
        pass
```

---

## Support

–í–æ–ø—Ä–æ—Å—ã? –ü—Ä–æ–±–ª–µ–º—ã?

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [DOCUMENT_MONITOR_README.md](./DOCUMENT_MONITOR_README.md) - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –≤ `api/routes/document_monitor.py`
3. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è debugging

**Happy coding! üöÄ**
