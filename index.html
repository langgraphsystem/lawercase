<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mega_agent_pro - Document Generation Monitor</title>

  <!--
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MEGA AGENT PRO - DOCUMENT GENERATION MONITOR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Purpose:
  --------
  Real-time monitoring dashboard for multi-agent legal document generation system.
  Tracks EB-1A petition generation progress across multiple specialized agents.

  Architecture Integration:
  -------------------------
  Backend: FastAPI (Python 3.11+)
  State Management: LangGraph WorkflowState
  Agents: CaseAgent, WriterAgent, ValidatorAgent, SupervisorAgent
  Memory: MemoryManager (episodic/semantic/working)

  API Endpoints Expected:
  -----------------------
  POST /api/generate-petition - Start new document generation
  GET  /api/document/preview/{thread_id} - Poll for status updates
  POST /api/upload-exhibit/{thread_id} - Upload exhibit files
  GET  /api/download-petition-pdf/{thread_id} - Download completed PDF
  POST /api/pause/{thread_id} - Pause generation
  POST /api/resume/{thread_id} - Resume generation

  Developer Instructions:
  -----------------------
  1. TESTING WITHOUT BACKEND:
     - Open index.html directly in browser
     - Click "ğŸ§ª Use Mock Data" button to simulate backend responses
     - All features will work with simulated data

  2. INTEGRATION WITH REAL BACKEND:
     - Update API_BASE constant in JavaScript (default: '/api')
     - Ensure CORS is enabled on FastAPI backend
     - Backend must return JSON matching DocumentPreviewResponse schema

  3. CUSTOMIZATION:
     - Colors: Search for CSS variables in :root selector
     - Polling interval: Change POLL_INTERVAL constant (default: 2000ms)
     - Document styles: Modify #document-preview styles

  4. DEPLOYMENT:
     - This is a standalone file - no build process needed
     - Can be served from FastAPI's static files
     - Or deploy to any web server (nginx, Apache, etc.)

  Browser Compatibility:
  ----------------------
  Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
  Uses: ES6+, Fetch API, CSS Grid, CSS Custom Properties

  File Size: ~50KB (no external dependencies)

  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CSS VARIABLES & RESET
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    :root {
      /* Color Palette */
      --color-primary: #0066cc;
      --color-primary-dark: #004d99;
      --color-primary-light: #3385d6;
      --color-success: #28a745;
      --color-warning: #ffc107;
      --color-danger: #dc3545;
      --color-info: #17a2b8;

      /* Neutral Colors */
      --color-bg-white: #ffffff;
      --color-bg-light: #f8f9fa;
      --color-bg-gray: #e9ecef;
      --color-border: #dee2e6;
      --color-text-dark: #212529;
      --color-text-medium: #6c757d;
      --color-text-light: #adb5bd;

      /* Status Colors */
      --status-pending: #6c757d;
      --status-in-progress: #0066cc;
      --status-completed: #28a745;
      --status-error: #dc3545;

      /* Spacing */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;

      /* Typography */
      --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-document: "Times New Roman", Times, serif;
      --font-mono: "Courier New", Courier, monospace;

      /* Layout */
      --sidebar-width: 300px;
      --controls-width: 320px;
      --header-height: 60px;

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-medium: 300ms ease;
      --transition-slow: 500ms ease;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg-white: #1a1a1a;
        --color-bg-light: #2d2d2d;
        --color-bg-gray: #3a3a3a;
        --color-border: #4a4a4a;
        --color-text-dark: #e9ecef;
        --color-text-medium: #adb5bd;
        --color-text-light: #6c757d;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: var(--font-ui);
      font-size: 14px;
      color: var(--color-text-dark);
      background: var(--color-bg-light);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LAYOUT - THREE PANEL DESIGN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .app-header {
      height: var(--header-height);
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--spacing-lg);
      box-shadow: var(--shadow-md);
      z-index: 100;
    }

    .app-header h1 {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .app-header .header-actions {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
    }

    .theme-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 4px;
      cursor: pointer;
      transition: background var(--transition-fast);
      font-size: 14px;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .header-toggle {
      display: none;
      align-items: center;
      gap: var(--spacing-xs);
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 4px;
      cursor: pointer;
      transition: background var(--transition-fast);
      font-size: 13px;
      font-weight: 500;
    }

    .header-toggle:hover {
      background: rgba(255, 255, 255, 0.35);
    }

    .header-toggle:focus-visible {
      outline: 2px solid rgba(255, 255, 255, 0.7);
      outline-offset: 2px;
    }

    /* Main content area */
    .app-main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left Sidebar */
    .sidebar {
      flex: 0 0 25%;
      max-width: 25%;
      min-width: 260px;
      background: var(--color-bg-light);
      border-right: 1px solid var(--color-border);
      overflow-y: auto;
      padding: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .sidebar-section {
      background: var(--color-bg-white);
      border-radius: 8px;
      padding: var(--spacing-md);
      box-shadow: var(--shadow-sm);
    }

    .sidebar-section h2 {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text-dark);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    /* Section list */
    .section-list {
      list-style: none;
    }

    .section-item {
      padding: var(--spacing-sm) var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      border-radius: 4px;
      cursor: pointer;
      transition: background var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      border-left: 3px solid transparent;
    }

    .section-item:hover {
      background: var(--color-bg-gray);
    }

    .section-item.active {
      background: var(--color-bg-gray);
      border-left-color: var(--color-primary);
    }

    .section-item .status-icon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .section-item .section-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-dark);
    }

    .section-item .section-time {
      font-size: 11px;
      color: var(--color-text-medium);
      white-space: nowrap;
    }

    /* Status indicators with animations */
    .status-pending { color: var(--status-pending); }
    .status-in-progress {
      color: var(--status-in-progress);
      animation: pulse 1.5s ease-in-out infinite;
    }
    .status-completed { color: var(--status-completed); }
    .status-error { color: var(--status-error); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .rotating {
      animation: spin 2s linear infinite;
    }

    /* Exhibits list */
    .exhibit-list {
      list-style: none;
    }

    .exhibit-item {
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      background: var(--color-bg-light);
      border-radius: 4px;
      font-size: 12px;
    }

    .exhibit-item .exhibit-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-xs);
    }

    .exhibit-item .exhibit-id {
      font-weight: 600;
      color: var(--color-primary);
    }

    .exhibit-item .exhibit-name {
      flex: 1;
      color: var(--color-text-dark);
      text-decoration: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .exhibit-item .exhibit-name:hover {
      text-decoration: underline;
    }

    .exhibit-item .exhibit-meta {
      color: var(--color-text-medium);
      font-size: 11px;
    }

    /* Main Content Area */
    .main-content {
      flex: 1 1 55%;
      max-width: 55%;
      min-width: 0;
      overflow-y: auto;
      background: var(--color-bg-gray);
      padding: var(--spacing-xl);
    }

    /* Document Preview Container */
    #document-preview {
      font-family: 'Times New Roman', serif;
      font-size: 11pt;
      line-height: 1.5;
      color: #000;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin: 20px auto;
      padding: 96px; /* 1 inch */
      max-width: 816px; /* 8.5 inch */
      min-height: 1056px; /* 11 inch */
      position: relative;
    }

    /* Dark mode override for document */
    @media (prefers-color-scheme: dark) {
      #document-preview {
        background: white;
        color: #000;
      }
    }

    /* Document Typography Styles */
    #document-preview h1 {
      text-align: center;
      font-size: 14pt;
      font-weight: bold;
      margin: 24pt 0 12pt 0;
      text-transform: uppercase;
    }

    #document-preview h2 {
      font-size: 12pt;
      font-weight: bold;
      margin: 18pt 0 6pt 0;
    }

    #document-preview h3 {
      font-size: 11pt;
      font-weight: bold;
      margin: 12pt 0 6pt 0;
    }

    #document-preview p {
      text-align: justify;
      margin: 0 0 12pt 0;
      text-indent: 0.5in;
    }

    #document-preview p.no-indent {
      text-indent: 0;
    }

    #document-preview .indent {
      margin-left: 0.5in;
    }

    #document-preview .double-indent {
      margin-left: 1in;
    }

    #document-preview .bold {
      font-weight: bold;
    }

    #document-preview .italic {
      font-style: italic;
    }

    #document-preview .underline {
      text-decoration: underline;
    }

    #document-preview .center {
      text-align: center;
      text-indent: 0;
    }

    #document-preview .right {
      text-align: right;
      text-indent: 0;
    }

    #document-preview .exhibit {
      font-style: italic;
      font-weight: bold;
    }

    #document-preview .signature-block {
      margin-top: 48pt;
      margin-bottom: 24pt;
    }

    #document-preview .signature-line {
      border-bottom: 1px solid #000;
      width: 3in;
      margin: 12pt 0 6pt 0;
    }

    #document-preview ul, #document-preview ol {
      margin: 0 0 12pt 0.5in;
      padding-left: 0.5in;
    }

    #document-preview li {
      margin-bottom: 6pt;
    }

    /* Document Section Styles */
    .document-section {
      opacity: 1;
      transition: opacity var(--transition-medium);
      margin-bottom: var(--spacing-lg);
    }

    .document-section.fade-in {
      animation: fadeIn var(--transition-medium) ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-loading,
    .section-error {
      padding: var(--spacing-xl);
      text-align: center;
      border: 2px dashed var(--color-border);
      border-radius: 8px;
      margin: var(--spacing-lg) 0;
    }

    .section-loading {
      background: var(--color-bg-light);
    }

    .section-error {
      background: #fff5f5;
      border-color: var(--color-danger);
      color: var(--color-danger);
    }

    .section-pending {
      padding: var(--spacing-xl);
      text-align: center;
      border: 2px dashed var(--color-border);
      border-radius: 8px;
      margin: var(--spacing-lg) 0;
      background: rgba(108, 117, 125, 0.08);
      color: var(--color-text-medium);
      font-family: var(--font-ui);
    }

    .spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid var(--color-bg-gray);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-md);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-lg);
      color: var(--color-text-medium);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: var(--spacing-md);
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--color-text-dark);
    }

    .empty-state p {
      font-size: 14px;
    }

    /* Right Controls Panel */
    .controls-panel {
      flex: 0 0 20%;
      max-width: 20%;
      min-width: 260px;
      background: var(--color-bg-light);
      border-left: 1px solid var(--color-border);
      overflow-y: auto;
      padding: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .control-section {
      background: var(--color-bg-white);
      border-radius: 8px;
      padding: var(--spacing-md);
      box-shadow: var(--shadow-sm);
    }

    .control-section h3 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: var(--spacing-md);
      color: var(--color-text-dark);
    }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: var(--spacing-sm) var(--spacing-md);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
      text-decoration: none;
      font-family: var(--font-ui);
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--color-primary-dark);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--color-success);
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #218838;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text-dark);
    }

    .btn-outline:hover:not(:disabled) {
      background: var(--color-bg-gray);
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .btn-lg {
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: 16px;
    }

    .btn-sm {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 12px;
    }

    .btn-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    /* Forms */
    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      color: var(--color-text-dark);
    }

    .form-input {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 13px;
      font-family: var(--font-ui);
      transition: border-color var(--transition-fast);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .form-input::placeholder {
      color: var(--color-text-light);
    }

    /* File upload */
    .file-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      left: -9999px;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      border: 2px dashed var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
      color: var(--color-text-medium);
      font-size: 13px;
    }

    .file-upload-label:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
      background: rgba(0, 102, 204, 0.05);
    }

    .file-upload.has-file .file-upload-label {
      border-color: var(--color-success);
      color: var(--color-success);
      background: rgba(40, 167, 69, 0.05);
    }

    /* Progress bar */
    .progress {
      height: 8px;
      background: var(--color-bg-gray);
      border-radius: 4px;
      overflow: hidden;
      margin-top: var(--spacing-sm);
    }

    .progress-bar {
      height: 100%;
      background: var(--color-primary);
      transition: width var(--transition-medium);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      font-weight: 600;
    }

    .progress-bar.success {
      background: var(--color-success);
    }

    /* Statistics */
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--color-bg-gray);
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-size: 12px;
      color: var(--color-text-medium);
    }

    .stat-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text-dark);
    }

    .stat-value.highlight {
      color: var(--color-primary);
    }

    /* Logs */
    .log-container {
      max-height: 200px;
      overflow-y: auto;
      background: var(--color-bg-light);
      border-radius: 4px;
      padding: var(--spacing-sm);
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.4;
    }

    .log-entry {
      padding: var(--spacing-xs);
      margin-bottom: var(--spacing-xs);
      border-left: 2px solid transparent;
      padding-left: var(--spacing-sm);
    }

    .log-entry.info {
      border-left-color: var(--color-info);
    }

    .log-entry.success {
      border-left-color: var(--color-success);
    }

    .log-entry.error {
      border-left-color: var(--color-danger);
      background: rgba(220, 53, 69, 0.05);
    }

    .log-entry.warning {
      border-left-color: var(--color-warning);
    }

    .log-time {
      color: var(--color-text-medium);
      margin-right: var(--spacing-sm);
    }

    .log-message {
      color: var(--color-text-dark);
    }

    .log-agent {
      color: var(--color-primary);
      font-weight: 600;
      margin-right: var(--spacing-xs);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE DESIGN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    @media (max-width: 1200px) {
      .app-main {
        position: relative;
      }

      .main-content {
        flex: 1 1 100%;
        max-width: 100%;
      }

      .controls-panel {
        position: fixed;
        right: -100%;
        top: var(--header-height);
        height: calc(100vh - var(--header-height));
        z-index: 90;
        box-shadow: var(--shadow-xl);
        transition: right var(--transition-medium);
        max-width: 320px;
        width: 320px;
      }

      .controls-panel.open {
        right: 0;
      }

      .controls-toggle {
        display: inline-flex;
      }

      .header-actions {
        gap: var(--spacing-sm);
      }
    }

    @media (max-width: 768px) {
      .main-content {
        flex: 1 1 100%;
        max-width: 100%;
      }

      .sidebar {
        position: fixed;
        left: -100%;
        top: var(--header-height);
        height: calc(100vh - var(--header-height));
        z-index: 90;
        box-shadow: var(--shadow-xl);
        transition: left var(--transition-medium);
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-toggle {
        display: inline-flex;
      }

      .header-actions {
        gap: var(--spacing-xs);
      }

      .main-content {
        padding: var(--spacing-md);
      }

      #document-preview {
        padding: 48px 24px;
        max-width: 100%;
      }

      .app-header h1 {
        font-size: 16px;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ACCESSIBILITY
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    *:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --color-border: #000;
      }

      .btn {
        border: 2px solid currentColor;
      }
    }

    /* Reduce motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UTILITY CLASSES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .hidden {
      display: none !important;
    }

    .app-overlay {
      position: fixed;
      top: var(--header-height);
      left: 0;
      width: 100%;
      height: calc(100vh - var(--header-height));
      background: rgba(0, 0, 0, 0.35);
      z-index: 85;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-medium);
    }

    .app-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .text-center {
      text-align: center;
    }

    .text-muted {
      color: var(--color-text-medium);
    }

    .mt-sm { margin-top: var(--spacing-sm); }
    .mt-md { margin-top: var(--spacing-md); }
    .mt-lg { margin-top: var(--spacing-lg); }

    .mb-sm { margin-bottom: var(--spacing-sm); }
    .mb-md { margin-bottom: var(--spacing-md); }
    .mb-lg { margin-bottom: var(--spacing-lg); }
  </style>
</head>
<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       APPLICATION CONTAINER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

  <div class="app-container">

    <!-- Header -->
    <header class="app-header">
      <h1>
        <span>âš–ï¸</span>
        <span>mega_agent_pro</span>
        <span style="opacity: 0.7; font-size: 14px; font-weight: 400;">Document Monitor</span>
      </h1>

      <div class="header-actions">
        <button
          class="header-toggle sidebar-toggle"
          id="sidebar-toggle"
          aria-controls="sidebar"
          aria-expanded="false"
        >
          ğŸ“‹ ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ
        </button>
        <button
          class="header-toggle controls-toggle"
          id="controls-toggle"
          aria-controls="controls-panel"
          aria-expanded="false"
        >
          âš™ï¸ ĞŸĞ°Ğ½ĞµĞ»ÑŒ
        </button>
        <button class="btn btn-sm btn-outline" id="mock-data-btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
          ğŸ§ª Use Mock Data
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
          ğŸŒ“ Theme
        </button>
      </div>
    </header>

    <div class="app-overlay" id="app-overlay" aria-hidden="true"></div>

    <!-- Main Content -->
    <main class="app-main">

      <!-- Left Sidebar -->
      <aside class="sidebar" id="sidebar">

        <!-- Document Structure -->
        <div class="sidebar-section">
          <h2>ğŸ“‹ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°</h2>
          <ul class="section-list" id="section-list">
            <li class="empty-state">
              <div class="icon">ğŸ“</div>
              <p>Ğ¡ĞµĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸</p>
            </li>
          </ul>
        </div>

        <!-- Exhibits -->
        <div class="sidebar-section">
          <h2>ğŸ“ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Exhibits)</h2>
          <ul class="exhibit-list" id="exhibit-list">
            <li class="empty-state">
              <div class="icon">ğŸ“</div>
              <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ</p>
            </li>
          </ul>
        </div>

      </aside>

      <!-- Main Content Area -->
      <div class="main-content">
        <div id="document-preview">
          <!-- Document will be rendered here -->
          <div class="empty-state" id="empty-state">
            <div class="icon">ğŸ“„</div>
            <h3>Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°</h3>
            <p>ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ" Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ‚Ğ¸Ñ†Ğ¸Ğ¸ EB-1A</p>
            <p class="text-muted mt-md">
              Ğ˜Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ "ğŸ§ª Use Mock Data" Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
            </p>
          </div>
        </div>
      </div>

      <!-- Right Controls Panel -->
      <aside class="controls-panel" id="controls-panel">

        <!-- Control Buttons -->
        <div class="control-section">
          <h3>Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</h3>
          <div class="btn-group">
            <button class="btn btn-primary btn-lg btn-block" id="start-btn">
              ğŸš€ ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ
            </button>
            <button class="btn btn-secondary btn-block" id="download-btn" disabled>
              ğŸ“„ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ PDF
            </button>
            <button class="btn btn-outline btn-sm btn-block" id="restart-btn">
              ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ
            </button>
          </div>
        </div>

        <!-- Upload Exhibit -->
        <div class="control-section">
          <h3>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ</h3>
          <form id="exhibit-form">
            <div class="form-group">
              <label class="form-label" for="exhibit-id">Exhibit ID</label>
              <input
                type="text"
                class="form-input"
                id="exhibit-id"
                placeholder="Ğ½Ğ°Ğ¿Ñ€. 2.1.A"
              />
            </div>

            <div class="form-group">
              <div class="file-upload" id="file-upload">
                <input
                  type="file"
                  id="exhibit-file"
                  accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                />
                <label class="file-upload-label" for="exhibit-file">
                  <span>ğŸ“</span>
                  <span id="file-upload-text">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»</span>
                </label>
              </div>
            </div>

            <div class="progress hidden" id="upload-progress-container">
              <div class="progress-bar" id="upload-progress-bar" style="width: 0%">0%</div>
            </div>

            <button type="submit" class="btn btn-primary btn-block mt-sm">
              Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ
            </button>
          </form>
        </div>

        <!-- Statistics -->
        <div class="control-section">
          <h3>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</h3>
          <div id="statistics">
            <div class="stat-item">
              <span class="stat-label">ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ</span>
              <span class="stat-value highlight" id="stat-progress">0/0</span>
            </div>
            <div class="progress mt-sm mb-md">
              <div class="progress-bar" id="progress-bar-overall" style="width: 0%"></div>
            </div>

            <div class="stat-item">
              <span class="stat-label">Ğ’Ñ€ĞµĞ¼Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹</span>
              <span class="stat-value" id="stat-elapsed">00:00</span>
            </div>

            <div class="stat-item">
              <span class="stat-label">ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ</span>
              <span class="stat-value" id="stat-eta">--:--</span>
            </div>

            <div class="stat-item">
              <span class="stat-label">Ğ¢Ğ¾ĞºĞµĞ½Ğ¾Ğ²</span>
              <span class="stat-value" id="stat-tokens">0</span>
            </div>

            <div class="stat-item">
              <span class="stat-label">Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ</span>
              <span class="stat-value" id="stat-cost">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Logs -->
        <div class="control-section">
          <h3>Ğ–ÑƒÑ€Ğ½Ğ°Ğ» ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹</h3>
          <div class="log-container" id="log-container">
            <div class="log-entry info">
              <span class="log-time">00:00:00</span>
              <span class="log-message">Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ</span>
            </div>
          </div>
        </div>

      </aside>

    </main>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       JAVASCRIPT APPLICATION LOGIC
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

  <script>
    'use strict';

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFIGURATION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    const CONFIG = {
      API_BASE: '/api',
      POLL_INTERVAL: 2000, // ms (fallback for when WebSocket unavailable)
      MAX_POLL_ERRORS: 5,
      MOCK_MODE: false,
      USE_WEBSOCKET: true, // Use WebSocket for real-time updates instead of polling
      WS_RECONNECT_INTERVAL: 3000, // ms
    };

    const API_ENDPOINTS = {
      startGeneration: `${CONFIG.API_BASE}/generate-petition`,
      getStatus: (threadId) => `${CONFIG.API_BASE}/document/preview/${threadId}`,
      uploadExhibit: (threadId) => `${CONFIG.API_BASE}/upload-exhibit/${threadId}`,
      downloadPDF: (threadId) => `${CONFIG.API_BASE}/download-petition-pdf/${threadId}`,
      pauseGeneration: (threadId) => `${CONFIG.API_BASE}/pause/${threadId}`,
      resumeGeneration: (threadId) => `${CONFIG.API_BASE}/resume/${threadId}`,
      websocket: (threadId) => {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        return `${protocol}//${host}${CONFIG.API_BASE}/ws/document/${threadId}`;
      },
    };

    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const uploadWithProgress = (url, formData, onProgress) => new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);

      xhr.upload.addEventListener('progress', (event) => {
        if (event.lengthComputable && typeof onProgress === 'function') {
          const percent = Math.round((event.loaded / event.total) * 100);
          onProgress(percent);
        }
      });

      xhr.onreadystatechange = () => {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const response = xhr.responseText ? JSON.parse(xhr.responseText) : {};
              resolve(response);
            } catch (error) {
              resolve({});
            }
          } else {
            reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
          }
        }
      };

      xhr.onerror = () => reject(new Error('Network error during upload'));

      xhr.send(formData);
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOCK DATA FOR TESTING
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    const MOCK_DATA = {
      thread_id: 'mock-thread-12345',
      status: 'generating',
      sections: [
        {
          section_id: 'intro',
          section_name: 'I. INTRODUCTION',
          section_order: 1,
          status: 'completed',
          content_html: `
            <h1>PETITION FOR IMMIGRANT CLASSIFICATION<br/>PURSUANT TO INA Â§ 203(b)(1)(A)</h1>
            <h2>I. INTRODUCTION</h2>
            <p class="no-indent">This petition is submitted on behalf of <span class="bold">Dr. Jane Smith</span>,
            a distinguished researcher in artificial intelligence and machine learning, seeking classification as
            an alien of extraordinary ability pursuant to Section 203(b)(1)(A) of the Immigration and Nationality
            Act (INA). Dr. Smith has demonstrated sustained national and international acclaim in her field through
            groundbreaking research, prestigious awards, and significant contributions that have advanced the state
            of the art in AI safety and alignment.</p>
            <p>This petition establishes Dr. Smith's eligibility through extensive documentation of her extraordinary
            achievements, including peer-reviewed publications, citations by leading researchers, invited speaking
            engagements at top-tier conferences, and her pivotal role in developing novel approaches to AI interpretability.</p>
          `,
          updated_at: new Date().toISOString(),
          tokens_used: 450,
        },
        {
          section_id: 'background',
          section_name: 'II. BENEFICIARY BACKGROUND',
          section_order: 2,
          status: 'completed',
          content_html: `
            <h2>II. BENEFICIARY BACKGROUND</h2>
            <p class="no-indent">Dr. Jane Smith earned her Ph.D. in Computer Science from Stanford University in 2018,
            where her dissertation on "Neural Network Interpretability through Mechanistic Analysis" received the
            Outstanding Dissertation Award. She currently serves as a Principal Research Scientist at a leading AI
            research laboratory, where she leads a team of 12 researchers focused on AI safety.</p>
            <p>Her educational background includes:</p>
            <ul>
              <li>Ph.D. in Computer Science, Stanford University (2018)</li>
              <li>M.S. in Computer Science, MIT (2014)</li>
              <li>B.S. in Mathematics and Computer Science, UC Berkeley (2012)</li>
            </ul>
          `,
          updated_at: new Date(Date.now() - 30000).toISOString(),
          tokens_used: 320,
        },
        {
          section_id: 'awards',
          section_name: 'III. CRITERION 2.1 - AWARDS',
          section_order: 3,
          status: 'in_progress',
          content_html: '',
          updated_at: new Date(Date.now() - 10000).toISOString(),
        },
        {
          section_id: 'membership',
          section_name: 'IV. CRITERION 2.2 - MEMBERSHIPS',
          section_order: 4,
          status: 'pending',
          content_html: '',
          updated_at: new Date().toISOString(),
        },
        {
          section_id: 'publications',
          section_name: 'V. CRITERION 2.6 - SCHOLARLY ARTICLES',
          section_order: 5,
          status: 'pending',
          content_html: '',
          updated_at: new Date().toISOString(),
        },
      ],
      exhibits: [
        {
          exhibit_id: '2.1.A',
          filename: 'NeurIPS_Best_Paper_Award.pdf',
          file_path: '/exhibits/2.1.A.pdf',
          file_size: 1245678,
          mime_type: 'application/pdf',
          uploaded_at: new Date(Date.now() - 60000).toISOString(),
        },
        {
          exhibit_id: '2.6.A',
          filename: 'Smith_et_al_Nature_2023.pdf',
          file_path: '/exhibits/2.6.A.pdf',
          file_size: 3456789,
          mime_type: 'application/pdf',
          uploaded_at: new Date(Date.now() - 120000).toISOString(),
        },
      ],
      metadata: {
        total_sections: 5,
        completed_sections: 2,
        progress_percentage: 40,
        elapsed_time: 145, // seconds
        estimated_remaining: 218,
        total_tokens: 770,
        estimated_cost: 0.42,
      },
      logs: [
        {
          timestamp: new Date(Date.now() - 145000).toISOString(),
          level: 'info',
          message: 'Starting document generation workflow',
          agent: 'SupervisorAgent',
        },
        {
          timestamp: new Date(Date.now() - 120000).toISOString(),
          level: 'success',
          message: 'Introduction section completed',
          agent: 'WriterAgent',
        },
        {
          timestamp: new Date(Date.now() - 90000).toISOString(),
          level: 'success',
          message: 'Background section completed',
          agent: 'WriterAgent',
        },
        {
          timestamp: new Date(Date.now() - 60000).toISOString(),
          level: 'info',
          message: 'Retrieved 15 relevant publications from memory',
          agent: 'MemoryManager',
        },
        {
          timestamp: new Date(Date.now() - 30000).toISOString(),
          level: 'info',
          message: 'Generating awards section (Criterion 2.1)',
          agent: 'WriterAgent',
        },
      ],
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DOCUMENT MONITOR CLASS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    class DocumentMonitor {
      constructor(threadId, options = {}) {
        this.threadId = threadId;
        this.pollInterval = options.pollInterval || CONFIG.POLL_INTERVAL;
        this.isPolling = false;
        this.pollTimer = null;
        this.pollErrorCount = 0;
        this.startTime = null;
        this.hasStarted = false;
        this.mockMode = options.mockMode || CONFIG.MOCK_MODE;

        // Track which sections we've already rendered
        this.renderedSections = new Set();
      }

      async startPolling() {
        if (this.isPolling) {
          return;
        }

        this.isPolling = true;

        if (!this.hasStarted) {
          this.hasStarted = true;
          this.startTime = Date.now();
          UI.addLog('info', 'Starting real-time monitoring', 'DocumentMonitor');
        } else {
          if (!this.startTime) {
            this.startTime = Date.now();
          }
          UI.addLog('info', 'Resuming real-time monitoring', 'DocumentMonitor');
        }

        await this.poll();
      }

      async poll() {
        if (!this.isPolling) return;

        try {
          const data = this.mockMode
            ? await this.getMockData()
            : await this.fetchStatus();

          // Reset error count on success
          this.pollErrorCount = 0;

          // Update UI
          this.updateUI(data);

          // Auto-stop on completion or error
          if (data.status === 'completed') {
            this.stopPolling();
            this.onComplete(data);
          } else if (data.status === 'error') {
            this.stopPolling();
            this.onError(data);
          }

        } catch (error) {
          console.error('Polling error:', error);
          this.pollErrorCount++;

          if (this.pollErrorCount >= CONFIG.MAX_POLL_ERRORS) {
            this.stopPolling();
            UI.addLog('error', `Polling failed ${CONFIG.MAX_POLL_ERRORS} times. Stopped.`, 'DocumentMonitor');
            return;
          }

          UI.addLog('warning', `Polling error (attempt ${this.pollErrorCount}/${CONFIG.MAX_POLL_ERRORS})`, 'DocumentMonitor');
        }

        // Schedule next poll
        if (this.isPolling) {
          this.pollTimer = setTimeout(() => this.poll(), this.pollInterval);
        }
      }

      async fetchStatus() {
        const response = await fetch(API_ENDPOINTS.getStatus(this.threadId));
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return await response.json();
      }

      async getMockData() {
        // Simulate network delay
        await new Promise(resolve => setTimeout(resolve, 300));

        // Simulate progressive generation
        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);

        if (elapsed > 10 && MOCK_DATA.sections[2].status === 'in_progress') {
          MOCK_DATA.sections[2].status = 'completed';
          MOCK_DATA.sections[2].content_html = `
            <h2>III. CRITERION 2.1 - AWARDS AND PRIZES</h2>
            <p class="no-indent">Dr. Smith has received nationally and internationally recognized awards
            demonstrating her extraordinary ability in artificial intelligence research. These prestigious
            honors were granted based on rigorous peer evaluation and competitive selection processes.</p>
            <h3>NeurIPS Best Paper Award (2023)</h3>
            <p>Awarded by the Neural Information Processing Systems Foundation for the paper
            "Mechanistic Interpretability of Transformer Models." This is the most prestigious award in
            machine learning, with an acceptance rate of 0.1% among 12,000+ submissions.
            See <span class="exhibit">Exhibit 2.1.A</span>.</p>
          `;
          MOCK_DATA.sections[3].status = 'in_progress';
          MOCK_DATA.metadata.completed_sections = 3;
          MOCK_DATA.metadata.progress_percentage = 60;
          MOCK_DATA.logs.push({
            timestamp: new Date().toISOString(),
            level: 'success',
            message: 'Awards section completed',
            agent: 'WriterAgent',
          });
        }

        if (elapsed > 20 && MOCK_DATA.sections[3].status === 'in_progress') {
          MOCK_DATA.status = 'completed';
          MOCK_DATA.sections[3].status = 'completed';
          MOCK_DATA.sections[3].content_html = `
            <h2>IV. CRITERION 2.2 - MEMBERSHIPS</h2>
            <p class="no-indent">Dr. Smith holds memberships in prestigious professional associations
            that require outstanding achievements as judged by recognized experts.</p>
          `;
          MOCK_DATA.sections[4].status = 'completed';
          MOCK_DATA.sections[4].content_html = `
            <h2>V. CRITERION 2.6 - SCHOLARLY ARTICLES</h2>
            <p class="no-indent">Dr. Smith has authored 42 peer-reviewed publications in leading
            venues, with over 8,500 citations (h-index: 28).</p>
          `;
          MOCK_DATA.metadata.completed_sections = 5;
          MOCK_DATA.metadata.progress_percentage = 100;
          MOCK_DATA.logs.push({
            timestamp: new Date().toISOString(),
            level: 'success',
            message: 'All sections completed successfully',
            agent: 'SupervisorAgent',
          });
        }

        // Update metadata
        MOCK_DATA.metadata.elapsed_time = elapsed;
        MOCK_DATA.metadata.estimated_remaining = Math.max(0, 25 - elapsed);

        return MOCK_DATA;
      }

      updateUI(data) {
        UI.updateSidebar(data.sections, data.exhibits);
        UI.updateMainContent(data.sections);
        UI.updateStatistics(data.metadata);
        UI.updateLogs(data.logs);
        UI.updateControlButtons(data.status);
      }

      stopPolling() {
        this.isPolling = false;
        if (this.pollTimer) {
          clearTimeout(this.pollTimer);
          this.pollTimer = null;
        }
      }

      onComplete(data) {
        UI.addLog('success', 'Document generation completed!', 'DocumentMonitor');
        UI.showNotification('Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½!', 'success');

        // Enable download button
        const downloadBtn = document.getElementById('download-btn');
        downloadBtn.disabled = false;
      }

      onError(data) {
        UI.addLog('error', 'Document generation failed', 'DocumentMonitor');
        UI.showNotification('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°', 'error');
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UI MANAGER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    const UI = {
      // Update sidebar sections list
      updateSidebar(sections, exhibits) {
        const sectionList = document.getElementById('section-list');
        if (!sectionList) return;

        if (!Array.isArray(sections) || sections.length === 0) {
          if (!sectionList.querySelector('.empty-state')) {
            sectionList.innerHTML = `
              <li class="empty-state">
                <div class="icon">ğŸ“</div>
                <p>Ğ¡ĞµĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸</p>
              </li>
            `;
          }
          this.updateExhibits(exhibits);
          return;
        }

        const sortedSections = [...sections].sort((a, b) => (a.section_order ?? 0) - (b.section_order ?? 0));
        const seenIds = new Set();

        if (sectionList.querySelector('.empty-state')) {
          sectionList.innerHTML = '';
        }

        sortedSections.forEach((section, index) => {
          const sectionLabel = section.section_id ?? `section-${section.section_order ?? index}`;
          const sectionId = this.sanitizeId(sectionLabel, `section-${index}`);
          const sectionName = section.section_name || `Ğ Ğ°Ğ·Ğ´ĞµĞ» ${section.section_order ?? index + 1}`;
          const status = section.status || 'pending';

          seenIds.add(sectionId);

          let item = document.getElementById(`sidebar-section-${sectionId}`);

          if (!item) {
            item = document.createElement('li');
            item.className = 'section-item';
            item.id = `sidebar-section-${sectionId}`;
            item.dataset.sectionId = sectionId;
            item.setAttribute('role', 'button');
            item.setAttribute('tabindex', '0');

            item.addEventListener('click', () => {
              this.scrollToSection(sectionId);
            });

            item.addEventListener('keypress', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                this.scrollToSection(sectionId);
              }
            });

            sectionList.appendChild(item);
          }

          item.dataset.sectionId = sectionId;

          const statusIcon = this.getStatusIcon(status);
          const timeAgo = this.formatTimeAgo(section.updated_at);

          item.innerHTML = `
            <span class="status-icon status-${status} ${status === 'in_progress' ? 'rotating' : ''}"
                  aria-label="${status}">
              ${statusIcon}
            </span>
            <span class="section-name">${sectionName}</span>
            <span class="section-time">${timeAgo}</span>
          `;
        });

        sectionList.querySelectorAll('.section-item').forEach(item => {
          if (!seenIds.has(item.dataset.sectionId)) {
            item.remove();
          }
        });

        this.updateExhibits(exhibits);
      },

      updateExhibits(exhibits) {
        const exhibitList = document.getElementById('exhibit-list');
        if (!exhibitList) return;

        if (!Array.isArray(exhibits) || exhibits.length === 0) {
          exhibitList.innerHTML = `
            <li class="empty-state">
              <div class="icon">ğŸ“</div>
              <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ</p>
            </li>
          `;
          return;
        }

        if (exhibitList.querySelector('.empty-state')) {
          exhibitList.innerHTML = '';
        }

        const seenIds = new Set();

        exhibits.forEach((exhibit, index) => {
          const exhibitLabel = exhibit.exhibit_id ?? `exhibit-${index + 1}`;
          const exhibitId = this.sanitizeId(exhibitLabel, `exhibit-${index}`);
          const filename = exhibit.filename || 'Ğ¤Ğ°Ğ¹Ğ»';
          const filePath = exhibit.file_path || '#';
          const fileIcon = this.getFileIcon(exhibit.mime_type || '');
          const fileSize = this.formatFileSize(exhibit.file_size);

          seenIds.add(exhibitId);

          let item = document.getElementById(`exhibit-${exhibitId}`);

          if (!item) {
            item = document.createElement('li');
            item.className = 'exhibit-item';
            item.id = `exhibit-${exhibitId}`;
            item.dataset.exhibitId = exhibitId;
            exhibitList.appendChild(item);
          }

          item.dataset.exhibitId = exhibitId;

          item.innerHTML = `
            <div class="exhibit-header">
              <span>${fileIcon}</span>
              <span class="exhibit-id">${exhibitLabel}</span>
              <a href="${filePath}" class="exhibit-name"
                 download="${filename}"
                 title="${filename}">
                ${filename}
              </a>
            </div>
            <div class="exhibit-meta">${fileSize}</div>
          `;
        });

        exhibitList.querySelectorAll('.exhibit-item').forEach(item => {
          if (!seenIds.has(item.dataset.exhibitId)) {
            item.remove();
          }
        });
      },

      // Update main document content
      updateMainContent(sections) {
        const container = document.getElementById('document-preview');
        if (!container) return;

        const hasSections = Array.isArray(sections) && sections.length > 0;
        const emptyState = document.getElementById('empty-state');
        if (emptyState && hasSections) {
          emptyState.remove();
        }

        if (!hasSections) {
          if (!emptyState) {
            container.innerHTML = `
              <div class="empty-state" id="empty-state">
                <div class="icon">ğŸ“„</div>
                <h3>Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°</h3>
                <p>ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ" Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ‚Ğ¸Ñ†Ğ¸Ğ¸ EB-1A</p>
                <p class="text-muted mt-md">
                  Ğ˜Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ "ğŸ§ª Use Mock Data" Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
                </p>
              </div>
            `;
          }
          container.querySelectorAll('.document-section').forEach(section => section.remove());
          return;
        }

        const sortedSections = [...sections].sort((a, b) => (a.section_order ?? 0) - (b.section_order ?? 0));
        const renderedIds = new Set();

        sortedSections.forEach((section, index) => {
          const sectionLabel = section.section_id ?? `section-${section.section_order ?? index}`;
          const sectionId = this.sanitizeId(sectionLabel, `section-${index}`);
          const elementId = `section-${sectionId}`;
          const order = Number(section.section_order ?? index);
          const sectionName = section.section_name || `Ğ Ğ°Ğ·Ğ´ĞµĞ» ${order + 1}`;
          const status = section.status || 'pending';

          renderedIds.add(sectionId);

          let sectionElement = document.getElementById(elementId);

          if (!sectionElement) {
            sectionElement = document.createElement('div');
            sectionElement.className = 'document-section fade-in';
            sectionElement.id = elementId;
            sectionElement.dataset.order = String(order);
            sectionElement.dataset.sectionId = sectionId;
            this.insertSectionInOrder(container, sectionElement, order);
          } else {
            sectionElement.dataset.sectionId = sectionId;
            const currentOrder = Number(sectionElement.dataset.order ?? order);
            if (currentOrder !== order) {
              sectionElement.dataset.order = String(order);
              this.insertSectionInOrder(container, sectionElement, order);
            }
          }

          if (status === 'in_progress') {
            sectionElement.innerHTML = `
              <div class="section-loading">
                <div class="spinner"></div>
                <p class="center" style="font-family: var(--font-ui); margin-top: 1em;">
                  Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ ${sectionName}...
                </p>
              </div>
            `;
          } else if (status === 'completed' && section.content_html) {
            sectionElement.innerHTML = section.content_html;
          } else if (status === 'error') {
            const errorMessage = section.error_message || 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°';
            sectionElement.innerHTML = `
              <div class="section-error">
                <p class="center bold" style="font-family: var(--font-ui);">
                  âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ${sectionName}
                </p>
                <p class="center" style="font-family: var(--font-ui); font-size: 12px;">
                  ${errorMessage}
                </p>
              </div>
            `;
          } else {
            sectionElement.innerHTML = `
              <div class="section-pending">
                ğŸ•’ ${sectionName} Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
              </div>
            `;
          }
        });

        container.querySelectorAll('.document-section').forEach(sectionElement => {
          const sectionId = sectionElement.dataset.sectionId;
          if (sectionId && !renderedIds.has(sectionId)) {
            sectionElement.remove();
          }
        });
      },

      insertSectionInOrder(container, element, order) {
        const sections = Array.from(container.querySelectorAll('.document-section'));

        // Find insertion point
        let insertBefore = null;
        for (const section of sections) {
          const sectionOrder = parseInt(section.dataset.order);
          if (sectionOrder > order) {
            insertBefore = section;
            break;
          }
        }

        if (insertBefore) {
          container.insertBefore(element, insertBefore);
        } else {
          container.appendChild(element);
        }
      },

      // Update statistics panel
      updateStatistics(metadata) {
        const totalSections = Number(metadata?.total_sections ?? 0);
        const completedSections = Number(metadata?.completed_sections ?? 0);
        const progressLabel = document.getElementById('stat-progress');
        if (progressLabel) {
          progressLabel.textContent = `${completedSections}/${totalSections}`;
        }

        const progressBar = document.getElementById('progress-bar-overall');
        const rawProgress = Number(metadata?.progress_percentage ?? 0);
        const progress = Number.isFinite(rawProgress)
          ? Math.min(100, Math.max(0, rawProgress))
          : 0;
        if (progressBar) {
          progressBar.style.width = `${progress}%`;
          progressBar.classList.toggle('success', progress === 100);
        }

        const elapsedSeconds = Number(metadata?.elapsed_time ?? 0);
        const elapsedLabel = document.getElementById('stat-elapsed');
        if (elapsedLabel) {
          elapsedLabel.textContent = this.formatDuration(elapsedSeconds);
        }

        const etaSeconds = Number(metadata?.estimated_remaining ?? 0);
        const etaLabel = document.getElementById('stat-eta');
        if (etaLabel) {
          etaLabel.textContent = etaSeconds > 0 ? this.formatDuration(etaSeconds) : '--:--';
        }

        const totalTokens = Number(metadata?.total_tokens ?? 0);
        const tokensLabel = document.getElementById('stat-tokens');
        if (tokensLabel) {
          tokensLabel.textContent = Number.isFinite(totalTokens) ? totalTokens.toLocaleString() : '0';
        }

        const estimatedCost = Number(metadata?.estimated_cost ?? 0);
        const costLabel = document.getElementById('stat-cost');
        if (costLabel) {
          costLabel.textContent = Number.isFinite(estimatedCost) ? `$${estimatedCost.toFixed(2)}` : '$0.00';
        }
      },

      // Update logs
      updateLogs(logs) {
        if (!logs || logs.length === 0) return;

        const container = document.getElementById('log-container');

        logs.forEach(log => {
          // Check if log already exists
          const timestampValue = log.timestamp ? new Date(log.timestamp).getTime() : Date.now();
          const safeTimestamp = Number.isNaN(timestampValue) ? Date.now() : timestampValue;
          const messageFragment = (log.message || '')
            .toString()
            .slice(0, 24)
            .replace(/\s+/g, '-')
            .replace(/[^a-zA-ZĞ°-ÑĞ-Ğ¯0-9-_]/g, '')
            || 'log';
          const logId = `log-${safeTimestamp}-${messageFragment}`;
          if (document.getElementById(logId)) return;

          const entry = document.createElement('div');
          entry.className = `log-entry ${log.level}`;
          entry.id = logId;

          const timeString = new Date(safeTimestamp).toLocaleTimeString('ru-RU');

          entry.innerHTML = `
            <span class="log-time">${timeString}</span>
            ${log.agent ? `<span class="log-agent">[${log.agent}]</span>` : ''}
            <span class="log-message">${log.message}</span>
          `;

          container.appendChild(entry);
        });

        // Auto-scroll to bottom
        container.scrollTop = container.scrollHeight;
      },

      // Add single log entry
      addLog(level, message, agent = null) {
        const log = {
          timestamp: new Date().toISOString(),
          level,
          message,
          agent,
        };
        this.updateLogs([log]);
      },

      // Update control buttons state
      updateControlButtons(status) {
        const startBtn = document.getElementById('start-btn');
        const downloadBtn = document.getElementById('download-btn');

        if (!startBtn || !downloadBtn) {
          return;
        }

        let normalizedStatus = 'idle';
        if (status === 'generating' || status === 'in_progress') {
          normalizedStatus = 'generating';
        } else if (status === 'paused') {
          normalizedStatus = 'paused';
        } else if (status === 'completed') {
          normalizedStatus = 'completed';
        } else if (status === 'error') {
          normalizedStatus = 'error';
        }

        startBtn.dataset.status = normalizedStatus;
        downloadBtn.disabled = true;

        switch (normalizedStatus) {
          case 'generating':
            startBtn.innerHTML = 'â¸ï¸ ĞŸÑ€Ğ¸Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ';
            startBtn.disabled = false;
            break;
          case 'paused':
            startBtn.innerHTML = 'â–¶ï¸ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ';
            startBtn.disabled = false;
            break;
          case 'completed':
            startBtn.innerHTML = 'âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾';
            startBtn.disabled = true;
            downloadBtn.disabled = false;
            break;
          case 'error':
            startBtn.innerHTML = 'âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° â€“ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğµ';
            startBtn.disabled = false;
            break;
          default:
            startBtn.innerHTML = 'ğŸš€ ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ';
            startBtn.disabled = false;
            break;
        }
      },

      // Utility: Scroll to section
      scrollToSection(sectionId) {
        const safeId = this.sanitizeId(sectionId);
        const section = document.getElementById(`section-${safeId}`);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });

          // Highlight active section in sidebar
          document.querySelectorAll('.section-item').forEach(item => {
            item.classList.remove('active');
          });
          document.getElementById(`sidebar-section-${safeId}`)?.classList.add('active');
        }
      },

      // Utility: Sanitize identifier for DOM usage
      sanitizeId(value, fallbackPrefix = 'id') {
        const normalize = (input) => String(input ?? '')
          .trim()
          .normalize('NFKD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, '-')
          .replace(/[^a-zA-Z0-9-_]/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '')
          .toLowerCase();

        let sanitized = normalize(value);
        if (!sanitized) {
          sanitized = normalize(fallbackPrefix);
        }
        if (!sanitized) {
          sanitized = `id-${Date.now()}`;
        }
        return sanitized;
      },

      // Utility: Get status icon
      getStatusIcon(status) {
        const icons = {
          pending: 'ğŸ•’',
          in_progress: 'ğŸ”„',
          completed: 'âœ…',
          error: 'âŒ',
        };
        return icons[status] || 'âšª';
      },

      // Utility: Get file icon
      getFileIcon(mimeType) {
        const type = (mimeType || '').toLowerCase();
        if (type.includes('pdf')) return 'ğŸ“„';
        if (type.includes('image')) return 'ğŸ–¼ï¸';
        if (type.includes('word') || type.includes('document')) return 'ğŸ“Š';
        return 'ğŸ“';
      },

      // Utility: Format file size
      formatFileSize(bytes) {
        const value = Number(bytes);
        if (!Number.isFinite(value) || value < 0) return 'â€”';
        if (value < 1024) return `${value} B`;
        if (value < 1024 * 1024) return `${(value / 1024).toFixed(1)} KB`;
        return `${(value / (1024 * 1024)).toFixed(1)} MB`;
      },

      // Utility: Format duration
      formatDuration(seconds) {
        const totalSeconds = Math.max(0, Math.floor(Number(seconds) || 0));
        const mins = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      },

      // Utility: Format time ago
      formatTimeAgo(timestamp) {
        if (!timestamp) return 'â€”';
        const parsed = new Date(timestamp);
        if (Number.isNaN(parsed.getTime())) return 'â€”';
        const seconds = Math.max(0, Math.floor((Date.now() - parsed.getTime()) / 1000));

        if (seconds < 60) return `${seconds}Ñ Ğ½Ğ°Ğ·Ğ°Ğ´`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}Ğ¼ Ğ½Ğ°Ğ·Ğ°Ğ´`;
        return `${Math.floor(seconds / 3600)}Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´`;
      },

      // Show notification (simple implementation)
      showNotification(message, type = 'info') {
        this.addLog(type, message, 'System');
      },
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EVENT HANDLERS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    const LayoutController = (() => {
      const sidebar = document.getElementById('sidebar');
      const controlsPanel = document.getElementById('controls-panel');
      const overlay = document.getElementById('app-overlay');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const controlsToggle = document.getElementById('controls-toggle');
      let previousOverflow = '';

      const setOverlayVisible = (visible) => {
        if (!overlay) return;
        overlay.classList.toggle('visible', visible);
        overlay.setAttribute('aria-hidden', String(!visible));
        if (visible) {
          previousOverflow = document.body.style.overflow;
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = previousOverflow || '';
        }
      };

      const syncAria = () => {
        if (sidebarToggle) {
          const isOpen = !!sidebar && sidebar.classList.contains('open');
          sidebarToggle.setAttribute('aria-expanded', String(isOpen));
        }
        if (controlsToggle) {
          const isOpen = !!controlsPanel && controlsPanel.classList.contains('open');
          controlsToggle.setAttribute('aria-expanded', String(isOpen));
        }
      };

      const closeAll = () => {
        sidebar?.classList.remove('open');
        controlsPanel?.classList.remove('open');
        setOverlayVisible(false);
        syncAria();
      };

      const openSidebar = () => {
        if (!sidebar) return;
        sidebar.classList.add('open');
        controlsPanel?.classList.remove('open');
        setOverlayVisible(true);
        syncAria();
      };

      const openControls = () => {
        if (!controlsPanel) return;
        controlsPanel.classList.add('open');
        sidebar?.classList.remove('open');
        setOverlayVisible(true);
        syncAria();
      };

      sidebarToggle?.addEventListener('click', (event) => {
        event.preventDefault();
        const isOpen = sidebar?.classList.contains('open');
        if (isOpen) {
          closeAll();
        } else {
          openSidebar();
        }
      });

      controlsToggle?.addEventListener('click', (event) => {
        event.preventDefault();
        const isOpen = controlsPanel?.classList.contains('open');
        if (isOpen) {
          closeAll();
        } else {
          openControls();
        }
      });

      overlay?.addEventListener('click', closeAll);

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeAll();
        }
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth > 1200) {
          closeAll();
        }
      });

      return { closeAll };
    })();

    let currentMonitor = null;

    // Start generation button
    document.getElementById('start-btn').addEventListener('click', async function() {
      LayoutController?.closeAll?.();
      const btn = this;
      const currentStatus = btn.dataset.status || 'idle';
      const threadId = sessionStorage.getItem('current_thread_id');

      if (currentStatus === 'generating') {
        if (!threadId) {
          UI.showNotification('ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° Ğ´Ğ»Ñ Ğ¿Ğ°ÑƒĞ·Ñ‹', 'warning');
          UI.addLog('warning', 'Pause requested without active thread', 'UI');
          return;
        }

        btn.innerHTML = 'â³ ĞŸÑ€Ğ¸Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°...';
        btn.disabled = true;

        try {
          if (CONFIG.MOCK_MODE) {
            await delay(400);
          } else {
            const response = await fetch(API_ENDPOINTS.pauseGeneration(threadId), {
              method: 'POST',
            });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
          }

          if (currentMonitor) {
            currentMonitor.stopPolling();
          }

          UI.updateControlButtons('paused');
          UI.addLog('info', 'Generation paused', 'User');
          UI.showNotification('ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½', 'info');
        } catch (error) {
          console.error('Pause generation error:', error);
          UI.addLog('error', `Failed to pause generation: ${error.message}`, 'System');
          UI.showNotification('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¸Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ', 'error');
          UI.updateControlButtons('generating');
        } finally {
          btn.disabled = false;
        }

        return;
      }

      if (currentStatus === 'paused') {
        if (!threadId) {
          UI.showNotification('ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ', 'warning');
          UI.addLog('warning', 'Resume requested without active thread', 'UI');
          return;
        }

        btn.innerHTML = 'â³ Ğ’Ğ¾Ğ·Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ...';
        btn.disabled = true;

        try {
          if (CONFIG.MOCK_MODE) {
            await delay(400);
          } else {
            const response = await fetch(API_ENDPOINTS.resumeGeneration(threadId), {
              method: 'POST',
            });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
          }

          if (!currentMonitor) {
            currentMonitor = new DocumentMonitor(threadId, {
              mockMode: CONFIG.MOCK_MODE,
            });
          }

          currentMonitor.startPolling();

          UI.updateControlButtons('generating');
          UI.addLog('info', 'Generation resumed', 'User');
          UI.showNotification('ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ğ¾Ğ·Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½', 'success');
        } catch (error) {
          console.error('Resume generation error:', error);
          UI.addLog('error', `Failed to resume generation: ${error.message}`, 'System');
          UI.showNotification('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²Ğ¾Ğ·Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ', 'error');
          UI.updateControlButtons('paused');
        } finally {
          btn.disabled = false;
        }

        return;
      }

      // Start new generation
      btn.innerHTML = 'â³ Ğ—Ğ°Ğ¿ÑƒÑĞº...';
      btn.disabled = true;

      try {
        let threadId;

        if (CONFIG.MOCK_MODE) {
          // Mock mode
          threadId = 'mock-thread-12345';
          UI.addLog('info', 'Starting generation (MOCK MODE)', 'System');
        } else {
          // Real API call
          const response = await fetch(API_ENDPOINTS.startGeneration, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              case_id: 'demo-case-001',
              document_type: 'petition',
              user_id: 'demo-user',
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          threadId = data.thread_id;
          UI.addLog('info', `Started generation (thread: ${threadId})`, 'System');
        }

        // Save thread ID
        sessionStorage.setItem('current_thread_id', threadId);

        // Start monitoring
        currentMonitor = new DocumentMonitor(threadId, {
          mockMode: CONFIG.MOCK_MODE,
        });
        currentMonitor.startPolling();

        UI.updateControlButtons('generating');
        btn.disabled = false;

      } catch (error) {
        console.error('Start generation error:', error);
        UI.addLog('error', `Failed to start generation: ${error.message}`, 'System');
        btn.innerHTML = 'ğŸš€ ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ';
        btn.disabled = false;
      }
    });

    // Download PDF button
    document.getElementById('download-btn').addEventListener('click', function() {
      LayoutController?.closeAll?.();
      const threadId = sessionStorage.getItem('current_thread_id');
      if (!threadId) {
        UI.showNotification('No active document to download', 'warning');
        return;
      }

      if (CONFIG.MOCK_MODE) {
        UI.addLog('info', 'Download PDF (MOCK MODE - would download in production)', 'User');
        UI.showNotification('Ğ’ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ·Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° PDF', 'info');
      } else {
        window.location.href = API_ENDPOINTS.downloadPDF(threadId);
        UI.addLog('info', 'Downloading PDF...', 'User');
      }
    });

    // Restart button
    document.getElementById('restart-btn').addEventListener('click', function() {
      LayoutController?.closeAll?.();
      if (!confirm('Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ? Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ½.')) {
        return;
      }

      // Stop current monitor
      if (currentMonitor) {
        currentMonitor.stopPolling();
        currentMonitor = null;
      }

      // Clear UI
      document.getElementById('document-preview').innerHTML = `
        <div class="empty-state" id="empty-state">
          <div class="icon">ğŸ“„</div>
          <h3>Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°</h3>
          <p>ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ" Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ‚Ğ¸Ñ†Ğ¸Ğ¸ EB-1A</p>
        </div>
      `;

      document.getElementById('section-list').innerHTML = `
        <li class="empty-state">
          <div class="icon">ğŸ“</div>
          <p>Ğ¡ĞµĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸</p>
        </li>
      `;

      document.getElementById('exhibit-list').innerHTML = `
        <li class="empty-state">
          <div class="icon">ğŸ“</div>
          <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ</p>
        </li>
      `;

      // Reset stats
      document.getElementById('stat-progress').textContent = '0/0';
      document.getElementById('progress-bar-overall').style.width = '0%';
      document.getElementById('stat-elapsed').textContent = '00:00';
      document.getElementById('stat-eta').textContent = '--:--';
      document.getElementById('stat-tokens').textContent = '0';
      document.getElementById('stat-cost').textContent = '$0.00';

      // Reset buttons
      const startBtn = document.getElementById('start-btn');
      startBtn.innerHTML = 'ğŸš€ ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ';
      startBtn.dataset.status = 'idle';
      startBtn.disabled = false;

      document.getElementById('download-btn').disabled = true;

      sessionStorage.removeItem('current_thread_id');

      UI.addLog('info', 'System reset', 'User');
    });

    // Exhibit upload form
    document.getElementById('exhibit-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const threadId = sessionStorage.getItem('current_thread_id');
      const exhibitId = document.getElementById('exhibit-id').value.trim();
      const fileInput = document.getElementById('exhibit-file');
      const file = fileInput.files[0];

      if (!exhibitId) {
        alert('ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Exhibit ID');
        return;
      }

      if (!file) {
        alert('ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»');
        return;
      }

      if (!threadId && !CONFIG.MOCK_MODE) {
        alert('Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ');
        return;
      }

      const progressContainer = document.getElementById('upload-progress-container');
      const progressBar = document.getElementById('upload-progress-bar');

      progressContainer.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';

      try {
        if (CONFIG.MOCK_MODE) {
          // Simulate upload
          for (let i = 0; i <= 100; i += 10) {
            await delay(120);
            progressBar.style.width = `${i}%`;
            progressBar.textContent = `${i}%`;
          }

          UI.addLog('success', `Uploaded exhibit ${exhibitId}: ${file.name} (MOCK)`, 'User');

          // Add to mock data
          MOCK_DATA.exhibits.push({
            exhibit_id: exhibitId,
            filename: file.name,
            file_path: `/exhibits/${exhibitId}.pdf`,
            file_size: file.size,
            mime_type: file.type,
            uploaded_at: new Date().toISOString(),
          });

          UI.updateExhibits(MOCK_DATA.exhibits);

        } else {
          // Real upload
          const formData = new FormData();
          formData.append('exhibit_id', exhibitId);
          formData.append('file', file);

          const response = await uploadWithProgress(
            API_ENDPOINTS.uploadExhibit(threadId),
            formData,
            (percent) => {
              progressBar.style.width = `${percent}%`;
              progressBar.textContent = `${percent}%`;
            },
          );

          progressBar.style.width = '100%';
          progressBar.textContent = '100%';

          UI.addLog('success', `Uploaded exhibit ${exhibitId}: ${file.name}`, 'User');

          if (Array.isArray(response?.exhibits)) {
            UI.updateExhibits(response.exhibits);
          } else if (response?.exhibit) {
            UI.updateExhibits([response.exhibit]);
          }
        }

        // Reset form
        document.getElementById('exhibit-id').value = '';
        fileInput.value = '';
        document.getElementById('file-upload-text').textContent = 'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»';
        document.getElementById('file-upload').classList.remove('has-file');

        setTimeout(() => {
          progressContainer.classList.add('hidden');
        }, 1000);

      } catch (error) {
        console.error('Upload error:', error);
        UI.addLog('error', `Upload failed: ${error.message}`, 'System');
        progressContainer.classList.add('hidden');
      }
    });

    // File input change handler
    document.getElementById('exhibit-file').addEventListener('change', function() {
      const fileName = this.files[0]?.name || 'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»';
      document.getElementById('file-upload-text').textContent = fileName;

      if (this.files[0]) {
        document.getElementById('file-upload').classList.add('has-file');
      } else {
        document.getElementById('file-upload').classList.remove('has-file');
      }
    });

    // Mock data button
    document.getElementById('mock-data-btn').addEventListener('click', function() {
      CONFIG.MOCK_MODE = !CONFIG.MOCK_MODE;

      if (CONFIG.MOCK_MODE) {
        this.textContent = 'âœ… Mock Mode ON';
        this.style.background = 'rgba(40, 167, 69, 0.3)';
        UI.addLog('info', 'Mock mode enabled - using simulated data', 'System');
      } else {
        this.textContent = 'ğŸ§ª Use Mock Data';
        this.style.background = 'rgba(255, 255, 255, 0.2)';
        UI.addLog('info', 'Mock mode disabled - will use real API', 'System');
      }
    });

    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      UI.addLog('info', `Theme changed to ${isDark ? 'dark' : 'light'} mode`, 'User');
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INITIALIZATION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    // Check for existing session on load
    window.addEventListener('DOMContentLoaded', function() {
      const threadId = sessionStorage.getItem('current_thread_id');

      if (threadId) {
        UI.addLog('info', `Resuming session for thread: ${threadId}`, 'System');
        // Could optionally restart monitoring here
      }

      // Auto-enable mock mode for demo
      setTimeout(() => {
        document.getElementById('mock-data-btn').click();
      }, 500);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (currentMonitor) {
        currentMonitor.stopPolling();
      }
    });

  </script>

</body>
</html>
